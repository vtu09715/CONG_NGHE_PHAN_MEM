<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tuy·ªÉn d·ª•ng</title>

<style>
/* Reset v√† CƒÉn ch·ªânh chung */
body {
    margin: 0;
    background: #eef2f7; /* N·ªÅn s√°ng, d·ªãu m·∫Øt */
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #333;
    line-height: 1.6;
}

/* Th·∫ª Card ch√≠nh - Container n·ªôi dung */
.card {
    background: #fff;
    padding: 30px;
    margin: 30px auto;
    width: 90%;
    max-width: 1200px;
    border-radius: 12px; /* G√≥c bo tr√≤n h∆°n */
    box-shadow: 0 10px 30px rgba(0,0,0,0.08); /* ƒê·ªï b√≥ng n·ªïi b·∫≠t, m·ªÅm m·∫°i */
    transition: transform 0.3s ease;
}

.card:hover {
    box-shadow: 0 15px 40px rgba(0,0,0,0.1);
}

h3 {
    color: #004d99; /* M√†u ti√™u ƒë·ªÅ ƒë·∫≠m, chuy√™n nghi·ªáp */
    border-bottom: 2px solid #eef2f7;
    padding-bottom: 10px;
    margin-bottom: 20px;
}

/* N√∫t b·∫•m (Button) */
button {
    padding: 12px 25px;
    font-size: 16px;
    font-weight: bold;
    border: none;
    color: white;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.1s;
    margin-right: 10px; /* Kho·∫£ng c√°ch gi·ªØa c√°c n√∫t */
}

/* N√∫t Ch√≠nh (Primary) */
button:not(.secondary):not(.danger), .btnPrimary {
    background: #007bff;
}
button:not(.secondary):not(.danger):hover, .btnPrimary:hover {
    background: #0056b3;
    transform: translateY(-1px);
}

/* N√∫t Ph·ª• (Secondary) */
button.secondary { background: #6c757d; }
button.secondary:hover { 
    background: #5a6268; 
    transform: translateY(-1px);
}

/* N√∫t Nguy hi·ªÉm (Danger) */
button.danger { background: #dc3545; }
button.danger:hover { 
    background: #bd2130; 
    transform: translateY(-1px);
}

/* Input, Select, Textarea */
input, select, textarea {
    width: 100%;
    padding: 12px;
    margin: 8px 0 18px;
    border: 1px solid #cce0f0; /* Vi·ªÅn m√†u xanh nh·∫°t */
    border-radius: 8px;
    box-sizing: border-box; /* T√≠nh c·∫£ padding v√† border v√†o width */
    font-size: 15px;
    transition: border-color 0.3s, box-shadow 0.3s;
}

input:focus, select:focus, textarea:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    outline: none;
}

label {
    font-weight: bold;
    display: block;
    margin-top: 10px;
    color: #004d99;
}

/* B·∫£ng D·ªØ li·ªáu (Table) */
.table {
    width: 100%;
    border-collapse: separate; /* T√°ch bi·ªát ƒë·ªÉ d·ªÖ bo g√≥c */
    border-spacing: 0;
    margin-top: 15px;
    background: #fff;
    border-radius: 8px;
    overflow: hidden; /* Quan tr·ªçng ƒë·ªÉ bo g√≥c */
    border: 1px solid #eef2f7;
}

.table th,
.table td {
    border: none;
    border-bottom: 1px solid #f0f4f7; /* ƒê∆∞·ªùng k·∫ª ngang m·ªèng */
    padding: 15px 12px;
    text-align: left;
}

.table th {
    background: #f8faff; /* N·ªÅn ƒë·∫ßu b·∫£ng */
    color: #004d99;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 14px;
}

.table tr:last-child td {
    border-bottom: none;
}

.table tbody tr:hover {
    background: #e6f0ff; /* Hi·ªáu ·ª©ng hover cho d√≤ng */
    cursor: pointer;
}

/* ·∫®n/Hi·ªán */
.hidden { display: none !important; }

/* Menu Navbar */
.menu {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 30px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.menu-right {
    display: flex;
    gap: 15px;
    align-items: center;
}

/* Avatar */
.avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    overflow: hidden;
    border: 3px solid #007bff; /* Vi·ªÅn avatar n·ªïi b·∫≠t */
    cursor: pointer;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
    transition: border-color 0.3s;
}

.avatar:hover {
    border-color: #0056b3;
}

.avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Grid Tuy·ªÉn D·ª•ng */
.grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* C·ªôt r·ªông h∆°n */
    gap: 25px; /* Kho·∫£ng c√°ch l·ªõn h∆°n */
    margin-top: 20px;
}

/* Th·∫ª C√¥ng vi·ªác (Job) */
.job {
    background: #fff;
    border: 1px solid #e0e6ed;
    border-radius: 10px;
    padding: 15px;
    transition: box-shadow 0.3s, transform 0.3s;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.job:hover {
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    transform: translateY(-3px);
}

.job img {
    width: 100%;
    height: 180px; /* ·∫¢nh cao h∆°n */
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 10px;
}

.job h4 {
    color: #007bff;
    margin-top: 5px;
    margin-bottom: 8px;
}

/* Chi ti·∫øt h·ªì s∆° (adminDetail) */
#adminDetail {
    overflow: visible !important;
}

#adminDetail > div:first-child {
    display: flex;
    gap: 40px;
    flex-wrap: wrap;
    align-items: flex-start;
}

#adminDetail p {
    margin: 8px 0;
    font-size: 15px;
}

#adminDetail b {
    color: #004d99;
}

#aiBox {
    margin-top: 30px;
    border-top: 1px dashed #ccc;
    padding-top: 20px;
}

#ai_match {
    color: #28a745 !important; /* M√†u xanh l√° c√¢y cho ƒëi·ªÉm */
    font-size: 24px !important;
    font-weight: bold;
}

#ai_review {
    background: #f1f8ff; /* N·ªÅn nh·∫π cho ph·∫ßn ƒë√°nh gi√° AI */
    padding: 15px;
    border-radius: 8px;
    border-left: 5px solid #007bff;
    white-space: pre-wrap !important; /* ƒê·∫£m b·∫£o xu·ªëng d√≤ng theo n·ªôi dung */
    font-family: Consolas, monospace;
    color: #333;
    font-size: 14px;
}

/* Th√¥ng b√°o l·ªói/th√†nh c√¥ng */
p#loginMsg, p#regMsg, p#ad_msg {
    padding: 10px;
    border-radius: 6px;
    font-weight: bold;
    margin-top: 15px;
    text-align: center;
}
p#loginMsg[style*="color:red"], p#regMsg[style*="color:red"] {
    background: #f8d7da;
    color: #721c24 !important;
    border: 1px solid #f5c6cb;
}
p#profileMsg[style*="color:green"], p#ad_msg[style*="color:green"] {
    background: #d4edda;
    color: #155724 !important;
    border: 1px solid #c3e6cb;
}

/* Li√™n k·∫øt CV */
#cvPreview, #ct_CV {
    font-size: 15px;
    margin-top: 10px;
    display: block !important;
}

/* Footer cho Job Detail */
#jobDetail button {
    margin-top: 15px;
}


#lichModal {
    box-shadow:0 10px 30px rgba(0,0,0,0.3);
    padding:20px;
    border-radius:10px;
}

/* FIX BUTTON ƒê·ªíNG √ù */
.btnPrimary { background:#28a745; /* ƒê·ªïi m√†u ƒê·ªìng √Ω th√†nh xanh l√° c√¢y */ }
.btnPrimary:hover { background: #1e7e34; }


</style>
</head>

<body>

<!-- ================= LOGIN ================= -->
<div id="authCard" class="card">
    <h1>H·ªÜ TH·ªêNG TUY·ªÇN D·ª§NG CTY SAMSUNGTHAINGUYEN</h1>
    <h3>ƒêƒÇNG NH·∫¨P V√ÄO H·ªÜ TH·ªêNG</h3>
    <input id="loginUser" placeholder="T√™n ƒëƒÉng nh·∫≠p">
    <input id="loginPass" type="password" placeholder="M·∫≠t kh·∫©u">
    <button onclick="doLogin()">ƒêƒÉng nh·∫≠p</button>
    <button class="secondary" onclick="showRegister()">ƒêƒÉng k√Ω</button>
    <p id="loginMsg" style="color:red"></p>

    <div id="registerBox" class="hidden">
        <h3>ƒêƒÇNG K√ù T√ÄI KHO·∫¢N</h3>
        <input id="regUser" placeholder="T√™n ƒëƒÉng nh·∫≠p">
        <input id="regPass" type="password" placeholder="M·∫≠t kh·∫©u">
        <input id="regEmail" placeholder="Email">
        <input id="regPhone" placeholder="S·ªë ƒëi·ªán tho·∫°i">
        <button onclick="doRegister()">Ho√†n t·∫•t</button>
        <button class="secondary" onclick="hideRegister()">Quay l·∫°i</button>
        <p id="regMsg"></p>
    </div>
</div>

<!-- =============== PANEL ·ª®NG VI√äN =================== -->
<div id="userPanel" class="hidden">

    <div class="card menu">
        <h3>Trang ·ª©ng vi√™n</h3>
        <div class="menu-right">
            <button onclick="showJobs()">Tin tuy·ªÉn d·ª•ng</button>
            <button onclick="showMyApplications()">ƒê∆°n ƒë√£ ·ª©ng tuy·ªÉn</button>
            <div class="avatar" onclick="showProfile()">
                <img id="avatarImg" src="/uploads/default-avatar.png">
            </div>
            <button class="secondary" onclick="doLogout()">ƒêƒÉng xu·∫•t</button>
        </div>
    </div>

    <div id="jobsSection" class="card">
        <h3>Tin tuy·ªÉn d·ª•ng</h3>
        <div id="jobsGrid" class="grid">ƒêang t·∫£i...</div>
    </div>

    <div id="jobDetail" class="card hidden">
        <h3 id="jd_title"></h3>
        <p id="jd_mota"></p>
        <p><b>L∆∞∆°ng:</b> <span id="jd_luong"></span></p>
        <p><b>ƒê·ªãa ƒëi·ªÉm:</b> <span id="jd_diadiem"></span></p>
        <button id="jd_apply" onclick="applyJob()">·ª®ng tuy·ªÉn</button>
        <button class="secondary" onclick="showJobs()">Quay l·∫°i</button>
    </div>

    <!-- H·ªí S∆† ·ª®NG VI√äN -->
    <div id="profileSection" class="card hidden">
        <h3>H·ªì s∆° c√° nh√¢n</h3>

        <input id="hosoten" placeholder="H·ªç t√™n">
        <input id="hosongaysinh" type="date">
        <select id="hosogioitinh">
            <option value="">Gi·ªõi t√≠nh</option>
            <option>Nam</option>
            <option>N·ªØ</option>
            <option>Kh√°c</option>
        </select>
        <input id="hosodiachi" placeholder="ƒê·ªãa ch·ªâ">
        <input id="hosohocvan" placeholder="H·ªçc v·∫•n">
        <input id="hosokinhnghiem" placeholder="Kinh nghi·ªám">
        <input id="hosokynang" placeholder="K·ªπ nƒÉng">

        <input type="hidden" id="hosocvurl">

        <label>CV (PDF)</label>
        <input id="hoso_cvfile" type="file" accept="application/pdf">

        <p><a id="cvPreview" href="#" target="_blank" style="display:none;color:blue;font-weight:bold;">üìÑ Xem CV ƒë√£ l∆∞u</a></p>

        <label>·∫¢nh ƒë·∫°i di·ªán:</label>
        <input id="hosoanh" type="file">

        <p><img id="avatarPreview" src="" style="width:120px;height:120px;border-radius:6px;border:1px solid #ccc;display:none;"></p>

        <button onclick="saveProfile()">L∆∞u h·ªì s∆°</button>
        <button class="secondary" onclick="showJobs()">Quay l·∫°i</button>
        <p id="profileMsg" style="color:green"></p>
    </div>

    <div id="myApplications" class="card hidden">
        <h3>ƒê∆°n ƒë√£ ·ª©ng tuy·ªÉn</h3>
        <table class="table">
            <thead><tr><th>V·ªã tr√≠</th><th>Ng√†y n·ªôp</th><th>Tr·∫°ng th√°i</th></tr></thead>
            <tbody id="tblMyApps"></tbody>
        </table>
        <button class="secondary" onclick="showJobs()">Quay l·∫°i</button>
    </div>
</div>

<!-- ===================== PANEL ADMIN ========================== -->
<div id="adminPanel" class="hidden">

    <div class="card menu">
        <h3>Trang qu·∫£n tr·ªã</h3>
        <div class="menu-right">
            <button onclick="adminShowManageJobs()">X·ª≠ l√Ω tin tuy·ªÉn d·ª•ng</button>
            <button onclick="adminShowJobs()">Tin tuy·ªÉn d·ª•ng</button>
            <button onclick="adminShowPostJob()">ƒêƒÉng tin</button>
            <button onclick="adminShowApplicants()">·ª®ng vi√™n ·ª©ng tuy·ªÉn</button>
            <button onclick="adminShowApproved()">·ª®ng vi√™n ƒë∆∞·ª£c ƒë·ªìng √Ω</button>
            <button onclick="adminShowRejected()">·ª®ng vi√™n b·ªã t·ª´ ch·ªëi</button>
            <button class="secondary" onclick="doLogout()">ƒêƒÉng xu·∫•t</button>
        </div>
    </div>

    <div id="adminJobs" class="card">
        <h3>Danh s√°ch tin tuy·ªÉn d·ª•ng</h3>
        <table class="table" id="tblAdminJobs"></table>
    </div>

    <div id="adminPostJob" class="card hidden">
        <h3>ƒêƒÉng tin tuy·ªÉn d·ª•ng</h3>
        <label>Ti√™u ƒë·ªÅ</label><input id="ad_tieude">
        <label>M√¥ t·∫£</label><textarea id="ad_mota" rows="4"></textarea>
        <label>M·ª©c l∆∞∆°ng</label><input id="ad_mucluong">
        <label>ƒê·ªãa ƒëi·ªÉm</label><input id="ad_diadiem">
        <label>H√¨nh ·∫£nh</label><input id="ad_hinhanh" type="file">
        <button onclick="adminPostJob()">ƒêƒÉng tin</button>
        <button class="secondary" onclick="adminShowJobs()">Quay l·∫°i</button>
        <p id="ad_msg" style="margin-top:10px;color:green;"></p>
    </div>

    <!-- ·ª®NG VI√äN -->
    <div id="adminApplicants" class="card hidden">
        <h3>·ª®ng vi√™n ·ª©ng tuy·ªÉn</h3>
        <table class="table" id="tblAdminApplicants"></table>
    </div>

    <div id="adminApproved" class="card hidden">
        <h3>Danh s√°ch ·ª©ng vi√™n ƒê∆Ø·ª¢C ƒê·ªíNG √ù</h3>
        <table class="table" id="tblApproved"></table>
    </div>

    <div id="adminRejected" class="card hidden">
        <h3>Danh s√°ch ·ª©ng vi√™n B·ªä T·ª™ CH·ªêI</h3>
        <table class="table" id="tblRejected"></table>
    </div>
<div id="adminManageJobs" class="card hidden">
    <h3>X·ª≠ l√Ω tin tuy·ªÉn d·ª•ng</h3>
    <table class="table" id="tblManageJobs"></table>
</div>
<div id="adminJobDetail" class="card hidden">
    <h3>Chi ti·∫øt tin tuy·ªÉn d·ª•ng</h3>

    <p>M√£ tin: <b id="dt_ma"></b></p>

    <label>Ti√™u ƒë·ªÅ</label>
    <input id="dt_tieude">

    <label>M·ª©c l∆∞∆°ng</label>
    <input id="dt_luong">

    <label>ƒê·ªãa ƒëi·ªÉm</label>
    <input id="dt_diachi">

    <label>M√¥ t·∫£</label>
    <textarea id="dt_mota" rows="4"></textarea>

    <label>S·ªë l∆∞·ª£ng tuy·ªÉn</label>
    <input id="dt_soluong">

    <p>ƒê√£ duy·ªát: <b id="dt_daduyet"></b></p>

    <p id="dt_canhtbao" style="color:red;font-weight:bold"></p>

    <button class="btnPrimary" onclick="updateJob()">C·∫≠p nh·∫≠t</button>
    <button class="danger" onclick="deleteJob()">Xo√° tin</button>
    <button class="secondary" onclick="adminShowManageJobs()">Quay l·∫°i</button>
</div>

    <!-- ============ CHI TI·∫æT H·ªí S∆† ============ -->
    <div id="adminDetail" class="card hidden">
        <h3>Chi ti·∫øt h·ªì s∆° ·ª©ng vi√™n</h3>

        <div style="display:flex;gap:20px;flex-wrap:wrap;">

            <div>
                <div class="avatar" style="width:80px;height:80px;">
                    <img id="ct_Avatar" src="/uploads/default-avatar.png">
                </div>
                <p><a id="ct_CV" href="#" target="_blank">Xem CV</a></p>
            </div>

            <div style="flex:1;">
                <p>H·ªç t√™n: <b id="ct_HoTen"></b></p>
                <p>Ng√†y sinh: <b id="ct_NgaySinh"></b></p>
                <p>Gi·ªõi t√≠nh: <b id="ct_GioiTinh"></b></p>
                <p>ƒê·ªãa ch·ªâ: <b id="ct_DiaChi"></b></p>
                <p>H·ªçc v·∫•n: <b id="ct_HocVan"></b></p>
                <p>Kinh nghi·ªám: <b id="ct_KinhNghiem"></b></p>
                <p>K·ªπ nƒÉng: <b id="ct_KyNang"></b></p>
                <p>Email: <b id="ct_Email"></b></p>
                <p>SƒêT: <b id="ct_SDT"></b></p>
            </div>

            <div style="flex:1;">
                <p>V·ªã tr√≠: <b id="ct_TieuDe"></b></p>
                <p>L∆∞∆°ng: <b id="ct_MucLuong"></b></p>
                <p>ƒê·ªãa ƒëi·ªÉm: <b id="ct_DiaDiem"></b></p>
                <p>M√¥ t·∫£: <b id="ct_MoTa"></b></p>
                <p>Tr·∫°ng th√°i ƒë∆°n: <b id="ct_TrangThai"></b></p>
            </div>

        </div>

        <div id="aiBox" class="hidden">
            <h3>AI ƒë√°nh gi√° ·ª©ng vi√™n</h3>
            <p><b>ƒê·ªô ph√π h·ª£p:</b> <span id="ai_match" style="color:blue;font-size:18px"></span>%</p>
            <pre id="ai_review" style="white-space:pre-line"></pre>
        </div>

        <!-- ‚≠ê FIX BUTTON CLICK HERE -->
        <button id="btnDongY" class="btnPrimary" onclick="adminApprove('ƒê∆∞·ª£c ch·ªçn')">ƒê·ªìng √Ω</button>
        <button id="btnTuChoi" class="danger" onclick="adminApprove('T·ª´ ch·ªëi')">T·ª´ ch·ªëi</button>

        <button class="secondary" onclick="adminBack()">Quay l·∫°i</button>
    </div>

</div>
<script>
const $ = id => document.getElementById(id);
function show(id){ $(id).classList.remove("hidden"); }
function hide(id){ $(id).classList.add("hidden"); }

async function api(url, method="GET", body=null, isForm=false){
    const opt = { method, credentials:"same-origin" };
    if(body){
        if(isForm) opt.body = body;
        else{
            opt.headers = {"Content-Type":"application/json"};
            opt.body = JSON.stringify(body);
        }
    }
    const res = await fetch(url,opt);
    return res.json();
}

/* ========== AUTH ========== */
function showRegister(){ show("registerBox"); }
function hideRegister(){ hide("registerBox"); }

async function doRegister(){
    const r = await api("/register","POST",{
        username: $("regUser").value.trim(),
        password: $("regPass").value.trim(),
        email: $("regEmail").value.trim(),
        sdt: $("regPhone").value.trim()
    });
    $("regMsg").textContent = r.message || r.error || "";
}

async function doLogin(){
    const r = await api("/login","POST",{
        username:$("loginUser").value.trim(),
        password:$("loginPass").value.trim()
    });

    $("loginMsg").textContent = r.message || r.error || "";
    if(!r.user) return;

    hide("authCard");

    if(r.user.role === "Admin") enterAdmin();
    else enterUser();
}

async function doLogout(){
    await api("/logout");
    location.reload();
}

/* ========== USER MODE ========== */
function showMyApplications() {
    hide("jobsSection");
    hide("jobDetail");
    hide("profileSection");
    show("myApplications");
    loadMyApplications();
}

function enterUser(){
    hide("adminPanel");
    show("userPanel");
    showJobs();
    loadUserProfile();
}

function showJobs(){
    hide("jobDetail");
    hide("profileSection");
    hide("myApplications");
    show("jobsSection");
    loadJobs();
}
async function loadMyApplications(){
    const r = await api("/user/danhsachungtuyen");
    const tb = $("tblMyApps");

    tb.innerHTML = r.data.map(x => `
        <tr>
            <td>${x.TieuDe}</td>
            <td>${new Date(x.NgayNop).toLocaleDateString("vi-VN")}</td>

            <td>
                ${x.TrangThai}

                ${x.TrangThai === "ƒê∆∞·ª£c ch·ªçn" ? `
                    <br>
                    <button class="secondary" style="margin-top:5px"
                        onclick="xemLich_UngVien(${x.MaUngTuyen})">
                        Xem l·ªãch
                    </button>
                ` : ""}
            </td>
        </tr>
    `).join("");
}


async function loadJobs(){
    const r = await api("/admin/danhsachtin");
    window._jobs = r.data;

    const grid = $("jobsGrid");

    grid.innerHTML = r.data.map(j => `
        <div class="job">
            ${j.HinhAnh ? `<img src="${j.HinhAnh}">` : ""}
            <h4>${j.TieuDe}</h4>
            <p>${(j.MoTa||"").substring(0,100)}...</p>
            <button onclick="openJobDetail(${j.MaTin})">Xem</button>
        </div>
    `).join('');
}

function openJobDetail(id){
    hide("jobsSection");
    show("jobDetail");

    const j = (window._jobs || []).find(x => x.MaTin == id) || {};

    $("jd_title").textContent = j.TieuDe;
    $("jd_mota").textContent = j.MoTa;
    $("jd_luong").textContent = j.MucLuong;
    $("jd_diadiem").textContent = j.DiaDiem;

    $("jd_apply").dataset.id = id;
if (j.DaDuyet >= j.SoLuongTuyen) {
    $("jd_apply").disabled = true;
    $("jd_apply").innerText = "ƒê√£ ƒë·ªß ·ª©ng vi√™n";
    $("jd_apply").style.background = "#ccc";
} else {
    $("jd_apply").disabled = false;
    $("jd_apply").innerText = "·ª®ng tuy·ªÉn";
}

}

function applyJob(){
    const id = $("jd_apply").dataset.id;
    api("/user/ungtuyen","POST",{ maTin:id }).then(r=>{
        alert(r.message);
        showJobs();
    });
}

function showProfile(){
    hide("jobsSection");
    hide("jobDetail");
    hide("myApplications");
    show("profileSection");
    loadUserProfile();
}

async function loadUserProfile(){
    const r = await api("/user/thongtin");
    if(!r.data) return;

    const d = r.data;

    $("hosoten").value = d.HoTen || "";
    $("hosongaysinh").value = d.NgaySinh ? d.NgaySinh.split("T")[0] : "";
    $("hosogioitinh").value = d.GioiTinh || "";
    $("hosodiachi").value = d.DiaChi || "";
    $("hosohocvan").value = d.HocVan || "";
    $("hosokinhnghiem").value = d.KinhNghiem || "";
    $("hosokynang").value = d.KyNang || "";

    $("hosocvurl").value = d.CV_URL || "";

    $("cvPreview").style.display = d.CV_URL ? "inline-block" : "none";
    $("cvPreview").href = d.CV_URL || "#";

    if(d.Anh){
        $("avatarPreview").src = d.Anh;
        $("avatarPreview").style.display = "block";
        $("avatarImg").src = d.Anh + "?t=" + Date.now();
    }
}

async function saveProfile(){
    const fd = new FormData();
    fd.append("HoTen",$("hosoten").value);
    fd.append("NgaySinh",$("hosongaysinh").value);
    fd.append("GioiTinh",$("hosogioitinh").value);
    fd.append("DiaChi",$("hosodiachi").value);
    fd.append("HocVan",$("hosohocvan").value);
    fd.append("KinhNghiem",$("hosokinhnghiem").value);
    fd.append("KyNang",$("hosokynang").value);

    if($("hoso_cvfile").files[0]) 
        fd.append("CV_File",$("hoso_cvfile").files[0]);
    else 
        fd.append("CV_URL",$("hosocvurl").value);

    if($("hosoanh").files[0]) 
        fd.append("Anh",$("hosoanh").files[0]);

    const r = await api("/user/capnhat","POST",fd,true);

    $("profileMsg").textContent = r.message;

    if(r.anh){
        $("avatarImg").src = r.anh + "?t=" + Date.now();
        $("avatarPreview").src = r.anh;
        $("avatarPreview").style.display = "block";
    }

    if(r.cv){
        $("cvPreview").href = r.cv;
        $("cvPreview").style.display = "inline-block";
    }
}

/* ========== ADMIN MODE ========== */

let currentHoSo = null;
function adminShowPostJob(){
    hideAllAdminSections();
    show("adminPostJob");
}

function enterAdmin(){
    hide("userPanel");
    show("adminPanel");
    adminShowJobs();
}

function hideAllAdminSections(){
    hide("adminJobs");
    hide("adminApplicants");
    hide("adminDetail");
    hide("adminPostJob");
    hide("adminApproved");
    hide("adminRejected");
}

function adminShowJobs(){
    hideAllAdminSections();
    show("adminJobs");
    loadAdminJobs();
}

async function loadAdminJobs(){
    const r = await api("/admin/danhsachtin");
    $("tblAdminJobs").innerHTML = `
        <tr>
            <th>M√£</th><th>Ti√™u ƒë·ªÅ</th><th>L∆∞∆°ng</th><th>ƒê·ªãa ƒëi·ªÉm</th><th>Ng√†y ƒëƒÉng</th>
        </tr>
        ${r.data.map(t=>`
            <tr>
                <td>${t.MaTin}</td>
                <td>${t.TieuDe}</td>
                <td>${t.MucLuong}</td>
                <td>${t.DiaDiem}</td>
                <td>${new Date(t.NgayDang).toLocaleDateString("vi-VN")}</td>
            </tr>
        `).join("")}
    `;
}

function adminShowApplicants(){
    hideAllAdminSections();
    show("adminApplicants");
    loadAdminApplicants();
}

async function loadAdminApplicants(){
    const r = await api("/admin/ungvien");
    $("tblAdminApplicants").innerHTML = `
        <tr>
            <th>H·ªç t√™n</th><th>Email</th><th>SƒêT</th>
            <th>V·ªã tr√≠</th><th>Ng√†y n·ªôp</th><th>Tr·∫°ng th√°i</th><th></th>
        </tr>
        ${
            r.data.filter(x=>x.TrangThai==="Ch·ªù duy·ªát").map(u=>`
                <tr>
                    <td>${u.HoTen}</td>
                    <td>${u.Email}</td>
                    <td>${u.SoDienThoai}</td>
                    <td>${u.TieuDe}</td>
                    <td>${new Date(u.NgayNop).toLocaleDateString("vi-VN")}</td>
                    <td>${u.TrangThai}</td>
                    <td><button onclick="xemHoSo(${u.MaUngTuyen})">Xem</button></td>
                </tr>
            `).join("")
        }
    `;
}

function adminShowApproved(){
    hideAllAdminSections();
    show("adminApproved");
    loadApproved();
}

async function loadApproved(){
    const r = await api("/admin/ungvien");

    $("tblApproved").innerHTML = `
        <tr>
            <th>H·ªç t√™n</th>
            <th>Email</th>
            <th>SƒêT</th>
            <th>V·ªã tr√≠</th>
            <th>Ng√†y n·ªôp</th>
            <th>Tr·∫°ng th√°i</th>
            <th>L·ªãch ph·ªèng v·∫•n</th>
        </tr>
        ${
            r.data
            .filter(x => x.TrangThai === "ƒê∆∞·ª£c ch·ªçn")
            .map(u => `
                <tr>
                    <td>${u.HoTen}</td>
                    <td>${u.Email}</td>
                    <td>${u.SoDienThoai}</td>
                    <td>${u.TieuDe}</td>
                    <td>${new Date(u.NgayNop).toLocaleDateString("vi-VN")}</td>
                    <td style="color:green;font-weight:bold;">${u.TrangThai}</td>
                    
                    <td>
                        <button class="btnPrimary" onclick="moDatLich(${u.MaUngTuyen})">ƒê·∫∑t l·ªãch</button>
                        <button class="secondary" onclick="xemLich(${u.MaUngTuyen})">Xem l·ªãch</button>
                    </td>
                </tr>
            `).join("")
        }
    `;
}


function adminShowRejected(){
    hideAllAdminSections();
    show("adminRejected");
    loadRejected();
}

async function loadRejected(){
    const r = await api("/admin/ungvien");
    $("tblRejected").innerHTML = `
        <tr>
            <th>H·ªç t√™n</th><th>Email</th><th>SƒêT</th>
            <th>V·ªã tr√≠</th><th>Ng√†y n·ªôp</th><th>Tr·∫°ng th√°i</th></tr>
        ${
            r.data.filter(x=>x.TrangThai==="T·ª´ ch·ªëi").map(u=>`
                <tr>
                    <td>${u.HoTen}</td>
                    <td>${u.Email}</td>
                    <td>${u.SoDienThoai}</td>
                    <td>${u.TieuDe}</td>
                    <td>${new Date(u.NgayNop).toLocaleDateString("vi-VN")}</td>
                    <td style="color:red;font-weight:bold;">${u.TrangThai}</td>
                </tr>
            `).join("")
        }
    `;
}

async function xemHoSo(maUngTuyen){
    const r = await api(`/admin/xemhoso?maUngTuyen=${maUngTuyen}`);
    currentHoSo = r.data;

    hideAllAdminSections();
    show("adminDetail");

    const d = currentHoSo;

    $("ct_HoTen").textContent = d.HoTen;
    $("ct_NgaySinh").textContent = d.NgaySinh ? d.NgaySinh.split("T")[0] : "";
    $("ct_GioiTinh").textContent = d.GioiTinh;
    $("ct_DiaChi").textContent = d.DiaChi;
    $("ct_HocVan").textContent = d.HocVan;
    $("ct_KinhNghiem").textContent = d.KinhNghiem;
    $("ct_KyNang").textContent = d.KyNang;
    $("ct_Email").textContent = d.Email;
    $("ct_SDT").textContent = d.SoDienThoai;

    $("ct_TieuDe").textContent = d.TieuDe;
    $("ct_MoTa").textContent = d.MoTa;
    $("ct_MucLuong").textContent = d.MucLuong;
    $("ct_DiaDiem").textContent = d.DiaDiem;
    $("ct_TrangThai").textContent = d.TrangThai;

    $("ct_CV").href = d.CV_URL || "#";
    $("ct_Avatar").src = d.Anh ? d.Anh : "/uploads/default-avatar.png";

    callAIReview(d);
}

function callAIReview(data){
    show("aiBox");

    let score = Math.floor(Math.random()*41)+60;

    $("ai_match").textContent = score;
    $("ai_review").textContent = `
·ª®ng vi√™n: ${data.HoTen}
V·ªã tr√≠ ·ª©ng tuy·ªÉn: ${data.TieuDe}

‚Ä¢ Kinh nghi·ªám: ${data.KinhNghiem}
‚Ä¢ K·ªπ nƒÉng: ${data.KyNang}
‚Ä¢ H·ªçc v·∫•n: ${data.HocVan}

ƒê√°nh gi√° t·ªïng quan:
- H·ªì s∆° kh√° ph√π h·ª£p
- Ti·ªÅm nƒÉng ph√°t tri·ªÉn t·ªët
- Khuy·∫øn ngh·ªã: M·ªùi ph·ªèng v·∫•n
`;
}
/* ========== QU·∫¢N L√ù TIN TUY·ªÇN D·ª§NG ========== */

function adminShowManageJobs(){
    hideAllAdminSections();
    show("adminManageJobs");
    loadManageJobs();
}

async function loadManageJobs(){
    const r = await api("/admin/danhsachtin");

    $("tblManageJobs").innerHTML = `
        <tr>
            <th>M√£</th><th>Ti√™u ƒë·ªÅ</th><th>L∆∞∆°ng</th>
            <th>ƒê·ªãa ƒëi·ªÉm</th><th>S·ªë l∆∞·ª£ng tuy·ªÉn</th><th></th>
        </tr>
        ${r.data.map(t=>`
            <tr>
                <td>${t.MaTin}</td>
                <td>${t.TieuDe}</td>
                <td>${t.MucLuong}</td>
                <td>${t.DiaDiem}</td>
                <td>${t.SoLuongTuyen || "-"}</td>
                <td><button onclick="adminEditJob(${t.MaTin})">X·ª≠ l√Ω</button></td>
            </tr>
        `).join("")}
    `;
}

async function adminEditJob(maTin){
    const r = await api(`/admin/chitiettin?maTin=${maTin}`);

    hideAllAdminSections();
    show("adminJobDetail");

    const t = r.data;

    $("dt_ma").textContent = t.MaTin;
    $("dt_tieude").value = t.TieuDe;
    $("dt_luong").value = t.MucLuong;
    $("dt_diachi").value = t.DiaDiem;
    $("dt_mota").value = t.MoTa;
    $("dt_soluong").value = t.SoLuongTuyen;
    $("dt_daduyet").textContent = t.DaDuyet;

    
}

async function updateJob(){
    const body = {
        maTin: $("dt_ma").textContent,
        tieude: $("dt_tieude").value,
        mota: $("dt_mota").value,
        luong: $("dt_luong").value,
        diachi: $("dt_diachi").value,
        soluong: $("dt_soluong").value
    };

    const r = await api("/admin/suatin", "POST", body);

    if (r.error) {
        alert("L·ªói: " + r.error);
    } else {
        alert(r.message || "C·∫≠p nh·∫≠t th√†nh c√¥ng");
        
    }
}


async function deleteJob(){
    if(!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën xo√° tin n√†y?")) return;

    const maTin = $("dt_ma").textContent;

    const r = await api("/admin/xoatin", "POST", { maTin });
    alert(r.message);

    adminShowManageJobs();
}

/* ========== X√âT DUY·ªÜT ========== */
async function adminApprove(trangThai){
    if(!currentHoSo){
        alert("Kh√¥ng t√¨m th·∫•y h·ªì s∆°");
        return;
    }

    const maUngTuyen = currentHoSo.MaUngTuyen;

    const r = await api("/admin/xetduyet", "POST", {
        maUngTuyen,
        trangThai
    });

    alert(r.message);
    adminShowApplicants();
}
// m·ªü popup
function moDatLich(maUngTuyen) {
    $("pv_maUngTuyen").value = maUngTuyen;
    $("pv_ngay").value = "";
    $("pv_diadiem").value = "";
    $("pv_hinhthuc").value = "";
    $("pv_ghichu").value = "";
    show("lichModal");
}

function dongPopup() {
    hide("lichModal");
}

// g·ª≠i d·ªØ li·ªáu l√™n server
async function luuLichPhongVan() {
    const body = {
        maUngTuyen: $("pv_maUngTuyen").value,
        ThoiGian: $("pv_ngay").value,
        DiaDiem: $("pv_diadiem").value,
        HinhThuc: $("pv_hinhthuc").value,
        GhiChu: $("pv_ghichu").value
    };

    if (!body.ThoiGian) return alert("Vui l√≤ng ch·ªçn th·ªùi gian!");

    const r = await api("/admin/datlich", "POST", body);
    alert(r.message);

    dongPopup();
    adminShowApproved();
}

// xem l·ªãch ƒë√£ t·∫°o
async function xemLich(maUngTuyen) {
    const r = await api(`/admin/xemlich?maUngTuyen=${maUngTuyen}`);

    if (!r.data) return alert("·ª®ng vi√™n ch∆∞a c√≥ l·ªãch!");

    alert(
`L·ªäCH PH·ªéNG V·∫§N:

Th·ªùi gian: ${r.data.ThoiGian}
ƒê·ªãa ƒëi·ªÉm: ${r.data.DiaDiem}
H√¨nh th·ª©c: ${r.data.HinhThuc}
Ghi ch√∫: ${r.data.GhiChu}`
    );
}

async function xemLich_UngVien(maUT) {
    const r = await api(`/admin/xemlich?maUngTuyen=${maUT}`);

    if (!r.data) {
        alert("B·∫°n ch∆∞a c√≥ l·ªãch ph·ªèng v·∫•n.");
        return;
    }

    alert(
`L·ªäCH PH·ªéNG V·∫§N

Th·ªùi gian: ${r.data.ThoiGian}
ƒê·ªãa ƒëi·ªÉm: ${r.data.DiaDiem}
H√¨nh th·ª©c: ${r.data.HinhThuc}
Ghi ch√∫: ${r.data.GhiChu}`
    );
}

</script>
<!-- POPUP ƒê·∫∂T L·ªäCH -->
<div id="lichModal" class="card hidden" 
     style="max-width:500px;position:fixed;top:50%;left:50%;
            transform:translate(-50%,-50%);z-index:999;background:white;">
    <h3>ƒê·∫∑t l·ªãch ph·ªèng v·∫•n</h3>

    <label>Ng√†y ph·ªèng v·∫•n</label>
    <input type="datetime-local" id="pv_ngay">

    <label>ƒê·ªãa ƒëi·ªÉm</label>
    <input type="text" id="pv_diadiem" placeholder="Nh·∫≠p ƒë·ªãa ƒëi·ªÉm">

    <label>H√¨nh th·ª©c</label>
    <input type="text" id="pv_hinhthuc" placeholder="VD: Tr·ª±c ti·∫øp / Online">

    <label>Ghi ch√∫</label>
    <textarea id="pv_ghichu" rows="3"></textarea>

    <button class="btnPrimary" onclick="luuLichPhongVan()">G·ª≠i</button>
    <button class="secondary" onclick="dongPopup()">ƒê√≥ng</button>

    <input type="hidden" id="pv_maUngTuyen">
</div>

</body>
</html>
